---
layout: home
---

<script src="{{ 'pako/dist/pako.js' | node_module_url }}"></script>
<script src="{{ 'js-base64/base64.js' | node_module_url }}"></script>

{%- assign textarea_id = 'textarea' -%}

<textarea id="{{ textarea_id }}" autofocus wrap="off"></textarea>

<script>
    function main() {
        if (document.readyState !== 'loading') {
            document.addEventListener('DOMContentLoaded', run);
        } else {
            run();
        }
    }

    function run() {
        const textarea = document.getElementById('{{ textarea_id }}');
        loadValue(textarea);
        addValueListener(textarea);
        addHashListener(textarea);
    }

    function loadValue(textarea) {
        const value = retrieveValue();
        const oldValue = textarea.value;
        textarea.value = value;
        if (oldValue === '') {
            textarea.selectionStart = value.length;
        }
    }

    function addValueListener(textarea) {
        textarea.addEventListener('input', (event) => {
            storeValue(event.target.value);
        }, false);
    }

    function addHashListener(textarea) {
        window.addEventListener('hashchange', () => {
            loadValue(textarea);
        });
    }

    function retrieveValue() {
        const hash = window.location.hash;
        if (hash === '') { return ''; }
        return deserialize(hash.substring(1));
    }

    function storeValue(value) {
        window.location.hash = '#' + serialize(value);
    }

    function serialize(value) {
        if (value === '') { return ''; }
        const data = new TextEncoder().encode(value);
        const compressed = pako.deflate(data, { level: 9 });
        return Base64.fromUint8Array(compressed, true);
    }

    function deserialize(value) {
        const data = Base64.toUint8Array(value);
        return pako.inflate(data, { to: 'string' });
    }

    main();
</script>
